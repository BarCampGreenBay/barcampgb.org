<link rel="import" href="/vendor/core-media-query/core-media-query.html">
<link rel="import" href="/vendor/polymer/polymer.html">

<polymer-element name="scroll-area">
	<template>
		<link rel="stylesheet" href="/assets/components/scroll-area/scroll-area.css">
		<core-media-query query="min-width: 581px" queryMatches="{{fancyheader}}"></core-media-query>
		<content></content>
	</template>
	<script>
(function() {
	function onScroll_() {
		this.previousScrollY = this.latestKnownScrollY;
		this.latestKnownScrollY = window.scrollY;
		requestTick_.bind(this)();
	}

	function requestTick_() {
		if (!this.ticking) {
			window.requestAnimationFrame(update_.bind(this));
		}
		this.ticking = true;
	}

	function update_() {
		this.ticking = false; // Reset the tick so we can capture the next onScroll.

		var currentScrollY = this.latestKnownScrollY;
		var offset;
		var scale;
		// var previousScrollY = this.previousScrollY;

		this.smallBannerSizeReached = this.siteBannerHeight - currentScrollY < this.appBarHeight;  //80px;

		if (this.smallBannerSizeReached) {
			this.classList.add('scrolling');
			if (this.header) {
				this.header.classList.add('shrink');
				this.header.style.webkitTransform = 'scale(0.25)';
			}
		}
		else {
			this.classList.remove('scrolling');
			if (this.header) {
				offset = this.header.offsetTop - currentScrollY;
				if (offset <= 0) {
					// Fix and shrink header when it hits the top of the page.
					this.header.classList.add('shrink');
					scale = Math.max((100 - Math.abs(offset) / 2.6) / 100, 0.25);
					this.header.style.webkitTransform = 'scale('+ scale +')';
				}
				else {
					this.header.classList.remove('shrink');
					this.header.style.webkitTransform = 'scale(1)';
				}
			}
		}
	}

	Polymer('scroll-area', {
		latestKnownScrollY: 0,
		previousScrollY: 0,
		smallBannerSizeReached: false,
		ticking: false,
		fancyheader: true, // header sticks on scroll
		attached: function() {
			this.init();
		},
		init: function() {
			var siteBanner = this.querySelector('site-banner');
			this.appBar = siteBanner.querySelector('core-toolbar');
			this.header = siteBanner.querySelector('header');

			// Give DOM some time to do layout.
			this.async(function() {
				this.siteBannerHeight = siteBanner.offsetHeight;
				this.appBarHeight = this.appBar.offsetHeight;
			});

			// For testing.
			// this.siteBannerHeight = 286;
			// this.appBarHeight = 80;

			// bind() returns new function. Save named reference.
			this.onscroll = onScroll_.bind(this);

			this.fancyheaderChanged();

			// Handle pageload in middle of page.
			if (window.scrollY && this.fancyheader) {
				this.onscroll();
			}
		},
		fancyheaderChanged: function() {
			if (this.fancyheader) {
				window.addEventListener('scroll', this.onscroll, false);
			} else {
				window.removeEventListener('scroll', this.onscroll, false);
				this.classList.remove('scrolling');
				if (this.header) {
					this.header.classList.remove('shrink');
				}
			}
		}
	});
})();
</script>
</polymer-element>